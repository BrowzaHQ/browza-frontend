# .github/workflows/comment-vercel-preview.yml
name: Comment Vercel Preview URL

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  comment-url:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Vercel preview
        id: wait
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }} # optional but recommended
          BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          set -euo pipefail

          BASE_URL="https://api.vercel.com/v6/deployments?projectId=${VERCEL_PROJECT_ID}&target=preview&limit=10"
          # Scope to the correct team if provided
          if [ -n "${VERCEL_TEAM_ID:-}" ]; then
            BASE_URL="${BASE_URL}&teamId=${VERCEL_TEAM_ID}"
          fi

          # Poll up to ~5 minutes (30 * 10s)
          for i in $(seq 1 30); do
            # Get recent preview deployments
            resp="$(curl -sfL -H "Authorization: Bearer ${VERCEL_TOKEN}" "${BASE_URL}" || true)"

            # 1) Try exact BRANCH match with READY state
            url="$(echo "${resp}" | jq -r --arg BR "${BRANCH}" '
              .deployments
              | map(select(.state=="READY"))
              | map(select(.meta["githubCommitRef"]==$BR))
              | .[0].url // empty
            ')"

            # 2) Fallback to newest READY preview (no branch filter)
            if [ -z "${url}" ] || [ "${url}" = "null" ]; then
              url="$(echo "${resp}" | jq -r '
                .deployments
                | map(select(.state=="READY"))
                | .[0].url // empty
              ')"
            fi

            if [ -n "${url}" ] && [ "${url}" != "null" ]; then
              echo "url=https://${url}" >> "${GITHUB_OUTPUT}"
              exit 0
            fi

            sleep 10
          done

          # Don't fail the workflow if no URL yet; the comment step is gated by the output
          exit 0

      - name: Comment link on PR
        if: steps.wait.outputs.url
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          URL: ${{ steps.wait.outputs.url }}
        run: |
          body="Vercel Preview (public mirror): ${URL}"
          jq -n --arg body "$body" '{body:$body}' > body.json
          curl -sS -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Content-Type: application/json" \
            -d @body.json \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ github.event.number }}/comments"
